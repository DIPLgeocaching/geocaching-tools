<?xml version="1.0" encoding="windows-1252"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://xmlns.jcp.org/jsf/core"     
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:h="http://xmlns.jcp.org/jsf/html">

    <h:body>
        <ui:composition template="/WEB-INF/template.xhtml">

            <ui:define name="content">
                <div class="container">
                    <div class="row">
                        <h2>Settings</h2>
                        <div>
                            <input id="loadFromUrlInput" type="text" value="res/stereo-3d.jpg"/>
                            <input id="loadFromUrlButton" type="button" value="Load from URL"/>
                        </div>
                        <div id="debug"></div>
                        <div>
                            <input id="pensilButton" type="button" value="use pensil"/>
                            <input id="rubberButton" type="button" value="use rubber"/>
                            <a id="downloadButton" download="Canvas.png">Download Canvas</a>
                        </div>
                        <h2>Controll</h2>
                        <div>
                            <input id="mainControll" type="range"/>
                            <input id="precisionControll" type="range"/>
                        </div>
                        <canvas id="graphCanvas" width="800" height="50"/>
                        <div id="canvasParent">
                            <canvas id="mainCanvas" class="stereocanvas" width="800" height="400" style="z-index: 1;"/>
                            <canvas id="overlayCanvas" class="stereocanvas" width="800" height="400" style="z-index: 2;"/>
                        </div>
                    </div>
                </div>
                <style>
                    #canvasParent {
                        position:relative;
                    }
                    #overlayCanvas {
                        opacity: 0.8;
                        cursor: url('data:image/x-icon;base64,AAACAAEAICAQAAAAAADoAgAAFgAAACgAAAAgAAAAQAAAAAEABAAAAAAAAAIAAAAAAAAAAAAAEAAAAAAAAAAAAAAAhYWFAPqv6ADgm4sASkpKAJ/l7QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACIAAAAAAAAAAAAAAAAAAAEiIAAAAAAAAAAAAAAAAAAxEiIAAAAAAAAAAAAAAAADMxEgAAAAAAAAAAAAAAAAMzMxAAAAAAAAAAAAAAAAAzMzMAAAAAAAAAAAAAAAADMzMwAAAAAAAAAAAAAAAAMzMzAAAAAAAAAAAAAAAAAzMzMAAAAAAAAAAAAAAAADMzMwAAAAAAAAAAAAAAAABTMzAAAAAAAAAAAAAAAAAFVTMAAAAAAAAAAAAAAAAABFVQAAAAAAAAAAAAAAAAAARAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///////////////////////////////////////////////////////////////////////////////////////P////h////wP///4H///8D///+B////A////gf///wP///4H///+D////B////w////8///////////////w=='), auto;
                    }
                    .stereocanvas {
                        position:absolute;
                        left:0px;
                        top:0px;
                    }
                </style>
                <script src="res/js/paint.js"/>
                <script>
                    //<![CDATA[
                    window.onload = function () {

                        ;
                        /* get elements */
                        var img = new Image();
                        var canvasParent = document.getElementById('canvasParent');
                        var canvas = document.getElementById('mainCanvas');
                        var graph = document.getElementById('graphCanvas');
                        var overlay = document.getElementById('overlayCanvas');
                        var main = document.getElementById('mainControll');
                        var prec = document.getElementById('precisionControll');
                        var sizeChanged = true;
                        var graphData = [];

                        var downloadButton = document.getElementById('downloadButton');
                        var rubberButton = document.getElementById('rubberButton');
                        var pensilButton = document.getElementById('pensilButton');
                        rubberButton.addEventListener('click', function () {
                            window.paint.setCurrentTool('rubber');
                        }, false);
                        pensilButton.addEventListener('click', function () {
                            window.paint.setCurrentTool('pensil');
                        }, false);

                        var testStereogramm = function (pixels, tresh = 20, offset = 0) {
                            var d = pixels.data;
                            var cnt = 0;
                            for (var x = offset; x < pixels.width; x += 1) {
                                for (var y = 0; y < pixels.height; y += 1) {
                                    var i = (y * pixels.width + x) * 4;
                                    var r = d[i];
                                    var g = d[i + 1];
                                    var b = d[i + 2];
                                    if ((r + g + b) / 3 <= tresh)
                                        cnt += 1;
                                }
                            }
                            return 1.0 * cnt / (pixels.height * (pixels.width - offset));
                        };
                        var generateGraphData = function (img) {
                            var result = [];
                            var canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            var ctx = canvas.getContext('2d');
                            for (var i = 0; i < img.width; i += 1) {
                                ctx.globalCompositeOperation = 'source-over';
                                ctx.drawImage(img, 0, 0, img.width, img.height);
                                ctx.globalCompositeOperation = 'difference';
                                ctx.drawImage(img, i, 0, img.width, img.height);
                                var pixels = ctx.getImageData(0, 0, img.width, img.height);
                                result.push(testStereogramm(pixels, 20, i));
                            }
                            return result;
                        };

                        /**
                         * encodes the both layers into a png image and downloads it
                         */
                        var download = function () {
                            //create temporary canvas
                            var down = document.createElement('canvas');
                            down.width = canvas.width;
                            down.height = canvas.height;
                            //draw both layers onto temporary canvas
                            var ctx = down.getContext('2d');
                            ctx.drawImage(canvas, 0, 0, canvas.width, canvas.height);
                            ctx.drawImage(overlay, 0, 0, overlay.width, overlay.height);
                            //encode image into url
                            var dt = down.toDataURL('image/png');
                            //download the image
                            this.href = dt;
                        };
                        downloadButton.addEventListener('click', download, false);

                        /* initialize range inputs */
                        main.min = 0;
                        prec.max = +20;
                        prec.min = -20;
                        prec.value = 0;

                        /*
                         * This functions renders image two times shifted by 'diff' onto the provided context
                         * @param {CanvasRenderingContext2D} ctx 
                         * @param {Image} img
                         */
                        var renderImage = function (ctx) {
                            var diff = parseInt(main.value) + parseInt(prec.value);
                            debug.innerHTML = diff;
                            //it is important that the image is drawn in its original size on the canvas
                            //otherwise some stereo images do not cancel themselve out correctly 
                            //because of some default scalation filtering operations
                            ctx.drawImage(img, 0, 0, img.width, img.height);
                            ctx.globalCompositeOperation = 'difference';
                            ctx.drawImage(img, diff, 0, img.width, img.height);
                        };

                        var normalizeData = function (data) {
                            var result = [];
                            var mx = Math.max.apply(Math, data);
                            var mn = Math.min.apply(Math, data);
                            console.log('max ' + mx);
                            console.log('min ' + mn);
                            for (var i = 0; i < data.length; i += 1) {
                                result.push((data[i] - mn) / (mx - mn));
                            }
                            return result;
                        };

                        var renderGraph = function (ctx) {
                            if (graphData.length === 0)
                                return;
                            ctx.clearRect(0, 0, ctx.canvas.clientWidth, ctx.canvas.clientHeight);
                            ctx.beginPath();
                            ctx.moveTo(0, 0);
                            for (var i = 0; i < graphData.length; i++) {
                                ctx.lineTo(
                                        i * ctx.canvas.clientWidth / graphData.length,
                                        (1 - graphData[i]) * ctx.canvas.clientHeight
                                        );
                            }
                            ctx.stroke();
                        };


                        /*
                         * Updates the size's of the elements
                         */
                        var updateCanvas = function () {
                            // update the max value of the main range input
                            main.max = img.width;
                            // update height and width for the canvas
                            if (sizeChanged) {
                                graph.width = canvas.width = overlay.width = main.clientWidth;
                                canvas.height = overlay.height = canvas.width * (img.height / img.width);
                                sizeChanged = false;
                            }
                            // updates the size of the canvasParent
                            canvasParent.style.width = canvas.width + 'px';
                            canvasParent.style.height = canvas.height + 'px';
                        };


                        /*
                         *  
                         */
                        var render = function () {
                            updateCanvas();

                            var factor = canvas.width / img.width;
                            var ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.save();
                            ctx.scale(factor, factor);
                            renderImage(ctx);
                            ctx.restore();

                            renderGraph(graph.getContext('2d'));

                        };


                        var resetPrec = function () {
                            main.value = parseInt(parseInt(main.value) + parseInt(prec.value));
                            prec.value = 0;
                        };

                        var onimgload = function () {

                            var canvas = document.createElement('canvas');
                            var ctx = canvas.getContext('2d');
                            canvas.width = 400;
                            canvas.height = canvas.width * (img.height / img.width);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            setTimeout(function () {
                                graphData = normalizeData(generateGraphData(canvas));
                                render();
                            }, 0);
                            render();
                        };
                        main.addEventListener("mousemove", render, false);
                        prec.addEventListener("mousemove", render, false);
                        prec.addEventListener("mouseup", resetPrec, false);

                        document.getElementById('loadFromUrlButton').addEventListener('click', function () {
                            img = new Image();
                            img.addEventListener('load', onimgload, false);
                            //img.crossOrigin = "Anonymous";
                            img.src = document.getElementById('loadFromUrlInput').value;
                        });

                        window.paint.init(overlay);

                        //TODO: let the user choose the file, just set img.src again with a js function
//
//                        img.src = 'http://localhost:8080/geoui/res/kopf.jpg';
//                        img.src = 'http://localhost:8080/geoui/res/test.jpg';
//                        img.src = 'http://localhost:8080/geoui/res/text.png';
//                        img.src = 'http://localhost:8080/geoui/res/heart.png';
//                        img.src = 'http://localhost:8080/geoui/res/L-stereogram-tree.jpg'; 
//                        img.src = 'http://localhost:8080/geoui/res/what.png'; 
//                        img.src = 'http://localhost:8080/geoui/res/city.jpg';
//                        img.src = 'http://localhost:8080/geoui/res/geocaching.jpg'; 
//                        img.src = 'http://localhost:8080/geoui/res/ost.jpg';
//                        img.src = 'http://localhost:8080/geoui/res/nord.jpg';
//                        img.src = 'http://localhost:8080/geoui/res/stereo.jpg';
//                        img.src = 'http://localhost:8080/geoui/res/large.gif';
                    };
                    //]]>
                </script>
            </ui:define>
        </ui:composition>
    </h:body>
</html>
